{
  "$schema": "https://vega.github.io/schema/vega/v5.json"
  ,"width": 700
  ,"padding": {"left": 10, "top": 5, "right": 5, "bottom": 10}
  ,"autosize": "pad"
  ,"height": {"signal": "chartHeight"}
  ,"data": [
    {
      "name": "dataset",
      "format": {
        "type": "json",
        "parse": {
          "Commit Start": "date",
          "Commit Date": "date"
        }
      },
      "transform":[
        {
          "type": "collect",
          "sort": {
            "field": ["Assignee","SO+PD Number","Commit Date"],
            "order": ["ascending","ascending","ascending"]
          }
        }
        ,{
          "type": "sequence",
          "start":0,
          "stop":0,
          "as": "index"
        }
      ]
    }
    ,{
      "name": "dayBins",
      "source": "dataset",
      "transform": [
        {
          "type": "timeunit",
          "field": "StartDate",
          "units": ["year","month","date"],
          "as": ["year","month","date"]
        },
        {
          "type": "aggregate",
          "groupby": ["year", "month", "date"],
          "ops": ["min"],
          "fields": ["StartDate"],
          "as": ["tick"]
        }
      ]
    }
    ,{
      "name":"dayTicks",
      "transform":[
        {
          "type": "sequence",
          "start": {"signal":"dayStart"},
          "stop": {"signal":"dayStop"},
          "step": 86400000,
          "as": "ts"
        }
        ,{"type": "filter","expr": "datum.ts >= x0 && datum.ts <= x1"}
      ]
    }
    ,{
      "name":"weekTicks",
      "transform":[
        {
          "type": "sequence",
          "start": {"signal":"weekStart"},
          "stop": {"signal":"weekStop"},
          "step": 604800000,
          "as": "ts"
        }
        ,{"type": "filter","expr": "datum.ts >= x0 && datum.ts <= x1"}
      ]
    }
    ,{
      "name":"monthTicks",
      "transform":[
        {
          "type": "sequence",
          "start": 0,
          "stop": {"signal":"(utcyear(monthStop)-utcyear(monthStart))*12+(utcmonth(monthStop)-utcmonth(monthStart))"},
          "step": 1,
          "as": "k"
        },
        {
          "type": "formula", 
          "as": "ts",
          "expr": "utc(utcyear(monthStart) + floor((utcmonth(monthStart)+datum.k)/12),(utcmonth(monthStart)+datum.k)%12,1)"
        }
        ,{"type": "filter","expr": "datum.ts >= x0 && datum.ts <= x1"}
      ]
    }
    ,{
      "name":"yearTicks",
      "transform":[
        {
          "type": "sequence",
          "start": {"signal":"utcyear(yearStart)"},
          "stop": {"signal":"utcyear(yearStop)"},
          "step": 1,
          "as": "y"
        },
        {
          "type": "formula", 
          "as": "ts",
          "expr": "utc(datum.y,0,1)"
        }
        ,{"type": "filter","expr": "datum.ts >= x0 && datum.ts <= x1"}
      ]
    }
    ,{
      "name": "logdata",
      "values": [
        {}
      ],
      "transform":[
        {
          "type": "window",
          "ops": ["row_number"],
          "as": ["i"]
        },
        {
          "type": "formula",
          "as": "msg",
          "expr": "recordCount"
        }
      ]
    },
    {
      "name": "datasorted",
      "source": "dataset",
      "transform": [
        {
          "type": "window",
          "sort": [{"field": "Assignee"}, {"field": "SO+PD Number"}, {"field": "Commit Date"}],
          "ops": ["row_number"],
          "as": ["globalIndex"]
        },
        {
          "type": "formula",
          "as": "y",
          "expr": "(datum.globalIndex - 1) * 30"
        }
      ]
    },
    {
      "name": "positioned",
      "source": "dataset",
      "transform": [
        {
          "type": "window",
          "sort": [{"field": "Assignee"}, {"field": "SO+PD Number"}, {"field": "Commit Date"}],
          "ops": ["row_number"],
          "as": ["globalIndex"]
        },
        {
          "type": "formula",
          "as": "y",
          "expr": "(datum.globalIndex - 1) * 30"
        }
      ]
    },
    {
      "name": "groupPositions",
      "source": "positioned",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["Assignee"],
          "ops": ["min", "count", "max"],
          "fields": ["y", "y", "y"],
          "as": ["yStart", "rowCount", "yMax"]
        },
        {
          "type": "window",
          "as": ["groupIndex"],
          "ops": ["rank"]
        },
        {
          "type": "formula",
          "as": "isEven",
          "expr": "datum.groupIndex % 2 == 0"
        },
        {
          "type": "formula",
          "as": "labelY",
          "expr": "datum.yStart"
          //"expr": "datum.yStart + datum.rowCount * 15 - 15"
        }
      ]
    },
    {
      "name": "groupDividers",
      "source": "groupPositions",
      "transform": [
        {
          "type": "formula",
          "as": "dividerY",
          "expr": "datum.yStart + datum.rowCount * 30 - 5"
        },
        {
          "type": "filter",
          "expr": "datum.dividerY < data('positioned').length * 30 - 15"
        }
      ]
    }
  ],



  "signals": [
    {
      "name": "chartHeight",
      "update": "data('positioned').length * 30"
    }
    ,{
      "name": "height_of_chart1", 
      "value": 100
    }
    ,{"name": "rowspacing", "value": 30}
    ,{
      "name": "recordCount",
      "update": "'Records: ' + length(data('dataset'))"
    }
    ,{"name":"x0","update": "domain('x')[0]"}
    ,{"name":"x1","update": "domain('x')[1]"}
    ,{
      "name": "dayStart",
      "update": "utc(utcyear(x0),utcmonth(x0),utcdate(x0))"
    }
    ,{
      "name": "dayStop",
      "update": "utc(utcyear(x1),utcmonth(x1),utcdate(x1))"
    }
    ,{
      "name": "weekStart",
      "update": "utc(utcyear(x0),utcmonth(x0),utcdate(x0) - ((utcday(utc(utcyear(x0),utcmonth(x0),utcdate(x0)))+6)%7))"
    }
    ,{
      "name": "weekStop",
      "update": "utc(utcyear(x1),utcmonth(x1),utcdate(x1))"
    }
    ,{
      "name": "monthStart",
      "update": "utc(utcyear(x0),utcmonth(x0),1)"
    }
    ,{
      "name": "monthStop",
      "update": "utc(utcyear(x1),utcmonth(x1)+1,1)"
    }
    ,{
      "name": "yearStart",
      "update": "utc(utcyear(x0),0,1)"
    }
    ,{
      "name": "yearStop",
      "update": "utc(utcyear(x1)+1,0,1)"
    }
    
  ],

  "scales": [
    {
      "name": "x",
      "type": "time",
      "domain": {"data": "dataset", "fields": ["Commit Start", "Commit Date"]},
      "range": "width"
    }
  ],

  "axes": [
    {
      "scale": "x",
      "orient": "bottom",
      //"bandPosition": 0.5,
      "format": "%b %d",
      "zindex": 1,
      //"grid": true,
      //"labels": true,
      "labelOverlap": "parity",
      "labelAlign": "left",
      "labelAngle": 90,
      "labelBaseline": "middle"
      ,"ticks": true
      //,"tickCount": {"interval":"month","step":1}
    }
  ],


  "marks": [
    {
      "type": "group"
      ,"name": "chart1_group"
      ,"encode": {
        "enter": {"y": {"value":0}}
      }
      ,"marks": [
        {
          "type": "symbol",
          "encode": {
            "enter": {
              "x": {"value": 20},
              "y": {"signal": "datum.i * 15 + 15"},
              "text": {"field": "msg"},
              "fontSize": {"value": 12},
              "fill": {"value": "black"}
            }
          }
        }
      ]
    }
    ,{
      "type": "group"
      ,"name": "chart2_group"
      ,"encode": {
        "enter": {"y": {"signal":"height_of_chart1"}}
      }
      ,"marks": [
        {
          "type": "text",
          "encode": {
            "enter": {
              "x": {"value": 100},
              "y": {"signal": "datum.i * 15 + 15"},
              "text": {"signal": "height_of_chart1"},
              "fontSize": {"value": 12},
              "fill": {"value": "black"}
            }
          }
        },
        {// group background
          "type": "rect",
          "from": {"data": "groupPositions"},
          "encode": {
            "enter": {
              "x": {"value": -260},
              "x2": {"signal": "width"},
              "y": {"signal": "datum.yStart - 5"},
              "height": {"signal": "datum.rowCount * 30"},
              "fill": {"signal": "datum.isEven ? \"#fffbed\" : \"transparent\""}
            }
          }
        },
          {
          "type": "rule",
          "from": {"data": "groupDividers"},
          "encode": {
            "enter": {
              "x": {"value": -260},
              "x2": {"signal": "width"},
              "y": {"field": "dividerY"},
              "stroke": {"value": "#8a8884"},
              "strokeWidth": {"value": 2},
              "strokeDash": {"value": [2, 2]}
            }
          }
        },
        {
          "type": "text",
          "from": {"data": "groupPositions"},
          "encode": {
            "enter": {
              "x": {"value": -250},
              "y": {"field": "labelY"},
              "text": {"field": "Assignee"},
              "fontSize": {"value": 14},
              "fontWeight": {"value": "bold"},
              "align": {"value": "left"},
              "baseline": {"value": "top"},
              "fill": {"value": "#000"}
            }
          }
        }
        ,{// ticks
          "type": "rule",
          "from": {"data": "dayTicks"},
          "encode": {
            "enter": {
              "x": {"scale": "x", "signal": "toDate(datum.ts)"},
              "y": {"value": 0},
              "y2": {"signal": "chartHeight"},
              "stroke": {"value": "#eee"},
              "strokeWidth": {"value": 0.5}
            }
          }
        }
        ,{// ticks
          "type": "rule",
          "from": {"data": "weekTicks"},
          "encode": {
            "enter": {
              "x": {"scale": "x", "signal": "toDate(datum.ts)"},
              "y": {"value": 0},
              "y2": {"signal": "chartHeight"},
              "stroke": {"value": "#ddd"},
              "strokeWidth": {"value": 1}
            }
          }
        }
        ,{// ticks
          "type": "rule",
          "from": {"data": "monthTicks"},
          "encode": {
            "enter": {
              "x": {"scale": "x", "signal": "toDate(datum.ts)"},
              "y": {"value": 0},
              "y2": {"signal": "chartHeight"},
              "stroke": {"value": "#bbb"},
              "strokeWidth": {"value": 1}
            }
          }
        }
        ,{// ticks
          "type": "rule",
          "from": {"data": "yearTicks"},
          "encode": {
            "enter": {
              "x": {"scale": "x", "signal": "toDate(datum.ts)"},
              "y": {"value": 0},
              "y2": {"signal": "chartHeight"},
              "stroke": {"value": "#888"},
              "strokeWidth": {"value": 1}
            }
          }
        }

        ,{ // Log Per Group
          "type": "text",
          "from": {"data": "groupPositions"},
          "encode": {
            "enter": {
              "x": {"value": -100},
              "y": {"field": "labelY"},
              "text": {"signal": "datum.groupIndex % 2"},
              "fontSize": {"value": 14},
              "fontWeight": {"value": "bold"},
              "align": {"value": "left"},
              "baseline": {"value": "top"},
              "fill": {"value": "#000"}
            }
          }
        }
        ,{ // Log Per Group
          "type": "text",
          "from": {"data": "groupPositions"},
          "encode": {
            "enter": {
              "x": {"value": -130},
              "y": {"field": "labelY"},
              "text": {"signal": "datum.isEven ? \"black\" : \"red\""},
              "fontSize": {"value": 14},
              "fontWeight": {"value": "bold"},
              "align": {"value": "left"},
              "baseline": {"value": "top"},
              "fill": {"value": "#000"}
            }
          }
        }

        ,{
          "type": "text",
          "from": {"data": "positioned"},
          "encode": {
            "enter": {
              "x": {"value": -100},
              "y": {"field": "y", "offset": 14},
              "text": {"field": "SO+PD Number"},
              "fontSize": {"value": 13},
              "align": {"value": "left"},
              "fill": {"value": "#333"}
            }
          }
        },
        {
          "type": "rect",
          "from": {"data": "positioned"},
          "encode": {
            "enter": {
              "x": {"scale": "x", "field": "Commit Start"},
              "x2": {"scale": "x", "field": "Commit Date"},
              "y": {"field": "y"},
              "height": {"value": 20},
              "fill": {"value": "#4682b4"}
              ,"tooltip": {
                "signal": "datum"
              }
            }
          }
        },
        {
          "type": "text",
          "from": {"data": "logdata"},
          "encode": {
            "enter": {
              "x": {"value": 10},
              "y": {"signal": "-10"},
              "text": {"field": "msg"},
              "fontSize": {"value": 12},
              "fill": {"value": "black"}
            }
          }
        }

      ]

      
    }
    
    
  ]


}
